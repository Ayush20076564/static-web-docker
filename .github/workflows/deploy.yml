name: ðŸš€ Auto Deploy aj-static-site to EC2 with Ansible

on:
  push:
    branches:
      - main   # Deploy automatically when pushing to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Step 2: Install Ansible
      - name: Install Ansible
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ansible

      # âœ… Step 3: Build Docker image
      - name: Build Docker image
        run: |
          docker build --no-cache -t aj-static-site:latest -f docker/Dockerfile .

      # âœ… Step 4: Save Docker image as tar
      - name: Save Docker image
        run: |
          docker save aj-static-site:latest -o static-web.tar
          sudo chmod 777 static-web.tar
          ls -lh static-web.tar

      # âœ… Step 5: Copy image to EC2
      - name: Copy image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "static-web.tar"
          target: "/home/ubuntu/static-web.tar"
          overwrite: true

      # âœ… Step 6: Debug â€” list repo structure
      - name: Debug repo structure
        run: |
          echo "Current path:" && pwd
          echo "Listing repo contents:" && ls -R

      # âœ… Step 7: Run Ansible playbook
      - name: ðŸ§© Run Ansible Playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        working-directory: ${{ github.workspace }}
        run: |
          echo "ðŸš€ Running Ansible playbook..."
          ansible-playbook -i hosts.ini ansible/deploy.yml \
            --private-key <(echo "${{ secrets.EC2_KEY }}") \
            -u ubuntu
