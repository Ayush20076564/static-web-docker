name: "Full CI/CD: Terraform + Docker + Ansible Deployment"

on:
  push:
    branches:
      - main  # Trigger workflow when code is pushed to main branch

jobs:
  build:
    name: "Infrastructure & Build Stage"
    runs-on: ubuntu-latest

    steps:
      # STEP 1: Checkout repository to access Terraform & Docker files
      - name: Checkout repository
        uses: actions/checkout@v4

      # STEP 2: Install Terraform CLI
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5  # Use any stable Terraform version

      # STEP 3: Terraform provisioning (create EC2 + security group)
      - name: Terraform Init & Apply
        run: |
          echo "üèóÔ∏è Initializing Terraform..."
          terraform init -input=false
          echo "üöÄ Applying Terraform (provisioning EC2 instance)..."
          terraform apply -auto-approve -input=false
          echo "‚úÖ Terraform provisioning complete!"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      # STEP 4: Build Docker image for static website
      - name: Build Docker image
        run: |
          echo "üõ†Ô∏è Building Docker image..."
          docker build --no-cache -t aj-static-site:latest -f docker/Dockerfile ./docker
          echo "‚úÖ Docker image built successfully!"

      # STEP 5: Save Docker image as tar file
      - name: Save Docker image as tar
        run: |
          echo "üì¶ Saving Docker image..."
          docker save aj-static-site:latest -o static-web.tar
          chmod 777 static-web.tar
          ls -lh static-web.tar
          echo "‚úÖ Docker image saved successfully!"

      # STEP 6: Upload tar artifact (to share with deploy job)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-web
          path: static-web.tar

  deploy:
    name: "Deployment Stage (Ansible + EC2)"
    runs-on: ubuntu-latest
    needs: build

    steps:
      # STEP 1: Checkout repository to get ansible/ folder
      - name: Checkout repository
        uses: actions/checkout@v4

      # STEP 2: Download built Docker image from previous job
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: static-web
          path: .

      # STEP 3: Copy Docker image tar to EC2 instance
      - name: Copy tar file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "static-web.tar"
          target: "/home/ubuntu/"
          overwrite: true

      # STEP 4: Run Ansible Playbook on EC2 (inline inventory)
      - name: Run Ansible playbook on EC2
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/deploy.yml
          inventory: |
            [all]
            ${{ secrets.EC2_HOST }} ansible_user=${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}

      # STEP 5: Verify container is running
      - name: Verify running container
        run: |
          echo "üîç Verifying container on EC2..."
          ssh -i .ansible_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "docker ps | grep aj-static-site"
          echo "‚úÖ Container is running!"
          echo "üåç Website available at: http://${{ secrets.EC2_HOST }}"
