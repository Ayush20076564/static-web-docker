name: ğŸš€ Full CI/CD: Terraform + Docker + Ansible Deployment

on:
  push:
    branches:
      - main   # ğŸ” Trigger workflow whenever code is pushed to main branch

jobs:
  build:
    name: ğŸ§± Infrastructure & Build Stage
    runs-on: ubuntu-latest

    steps:
      # ================================================================
      # ğŸ§© STEP 1: Checkout repository to access Terraform & Docker files
      # ================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================================================================
      # ğŸŒ STEP 2: Terraform provisioning (create EC2 + security group)
      # ================================================================
      - name: Terraform Init & Apply
        run: |
          echo "ğŸ—ï¸ Initializing Terraform..."
          cd terraform || cd .   # <-- adjust if terraform files are in root
          terraform init -input=false
          echo "ğŸš€ Applying Terraform (provisioning EC2 instance)..."
          terraform apply -auto-approve -input=false
          echo "âœ… Terraform provisioning complete!"
          cd ..
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      # ================================================================
      # ğŸ³ STEP 3: Build Docker image for static website
      # ================================================================
      - name: Build Docker image
        run: |
          echo "ğŸ› ï¸ Building Docker image..."
          docker build --no-cache -t aj-static-site:latest -f docker/Dockerfile ./docker
          echo "âœ… Docker image built successfully!"

      # ================================================================
      # ğŸ“¦ STEP 4: Save Docker image as tar file
      # ================================================================
      - name: Save Docker image as tar
        run: |
          echo "ğŸ“¦ Saving Docker image..."
          docker save aj-static-site:latest -o static-web.tar
          chmod 777 static-web.tar
          ls -lh static-web.tar
          echo "âœ… Docker image saved successfully!"

      # ================================================================
      # â˜ï¸ STEP 5: Upload tar artifact (shared with deploy job)
      # ================================================================
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-web
          path: static-web.tar

  deploy:
    name: ğŸš€ Deployment Stage (Ansible + EC2)
    runs-on: ubuntu-latest
    needs: build

    steps:
      # ================================================================
      # ğŸ§© STEP 1: Checkout repo (to access ansible folder)
      # ================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================================================================
      # ğŸ“¥ STEP 2: Download built Docker image from previous job
      # ================================================================
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: static-web
          path: .

      # ================================================================
      # ğŸ” STEP 3: Transfer Docker image to EC2 via SCP
      # ================================================================
      - name: Copy tar file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "static-web.tar"
          target: "/home/ubuntu/"
          overwrite: true

      # ================================================================
      # âš™ï¸ STEP 4: Run Ansible Playbook on EC2
      # ================================================================
      - name: Run Ansible playbook on EC2
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/deploy.yml
          inventory: |
            [all]
            ${{ secrets.EC2_HOST }} ansible_user=${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}

      # ================================================================
      # âœ… STEP 5: Verify deployment success
      # ================================================================
      - name: Verify running container
        run: |
          echo "ğŸ” Verifying container on EC2..."
          ssh -i .ansible_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "docker ps | grep aj-static-site"
          echo "âœ… Container is running!"
          echo "ğŸŒ Website available at: http://${{ secrets.EC2_HOST }}"
