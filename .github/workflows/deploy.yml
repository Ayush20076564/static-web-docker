# ============================================================
# ğŸŒ GITHUB ACTIONS WORKFLOW
# AUTOMATICALLY BUILDS AND DEPLOYS STATIC WEBSITE TO AWS EC2
# USING DOCKER + ANSIBLE
# ============================================================

name: "ğŸš€ Build and Deploy aj-static-site to EC2"

on:
  # ğŸ§© Trigger this workflow whenever code is pushed to the main branch
  push:
    branches:
      - main

jobs:
  # ============================================================
  # ğŸ”¨ BUILD JOB â€” builds Docker image for your static website
  # ============================================================
  build:
    name: "ğŸ”¨ Build Docker Image"
    runs-on: ubuntu-latest  # GitHub-hosted runner environment

    steps:
      # âœ… Step 1: Checkout your repository to access code and Dockerfile
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Step 2: Build Docker image using the Dockerfile in ./docker directory
      - name: Build Docker image
        run: |
          echo "ğŸ› ï¸ Building Docker image..."
          docker build --no-cache -t aj-static-site:latest -f docker/Dockerfile ./docker
          echo "âœ… Docker image built successfully!"

      # âœ… Step 3: Save Docker image to a .tar file for later transfer
      - name: Save Docker image as tar
        run: |
          echo "ğŸ“¦ Saving Docker image..."
          docker save aj-static-site:latest -o static-web.tar
          chmod 777 static-web.tar
          ls -lh static-web.tar
          echo "âœ… Docker image saved successfully!"

      # âœ… Step 4: Upload the tar file as an artifact to be shared with the deploy job
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-web        # Artifact name
          path: static-web.tar    # Path of the tar file to upload

  # ============================================================
  # ğŸš€ DEPLOY JOB â€” transfers Docker image and runs it on EC2
  # ============================================================
  deploy:
    name: "ğŸš€ Deploy to EC2 using Ansible"
    runs-on: ubuntu-latest
    needs: build  # Ensures 'build' job completes successfully first

    steps:
      # âœ… Step 1: Checkout repo again to access ansible/deploy.yml playbook
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… Step 2: Download the Docker image artifact created in the build job
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: static-web   # Must match the name used in upload step
          path: .            # Download to current working directory

      # âœ… Step 3: Copy Docker image tar file to your EC2 instance using SCP
      - name: Copy tar file to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}         # EC2 public IP
          username: ${{ secrets.EC2_USER }}     # e.g. 'ubuntu'
          key: ${{ secrets.EC2_KEY }}           # SSH private key from secrets
          source: "static-web.tar"              # File to copy
          target: "/home/ubuntu/"               # Target directory on EC2
          overwrite: true                       # Replace existing file if any

      # âœ… Step 4: Run Ansible playbook to deploy Docker container on EC2
      - name: Run Ansible playbook on EC2
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/deploy.yml           # Path to your Ansible playbook
          # Inline inventory definition (no separate hosts.ini file needed)
          inventory: |
            [all]
            ${{ secrets.EC2_HOST }} ansible_user=${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}            # Use SSH key from secrets

      # âœ… Step 5: Print deployment summary and site URL
      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Your static website is live at: http://${{ secrets.EC2_HOST }}"
