# ============================================================
# ğŸŒ GITHUB ACTIONS â€” FULL AUTOMATED CI/CD PIPELINE
# Terraform + Docker + Ansible Deployment to AWS EC2
# ============================================================

name: "ğŸš€ Provision & Deploy aj-static-site to AWS EC2"

on:
  push:
    branches:
      - main

jobs:
  # ============================================================
  # ğŸ§± TERRAFORM JOB â€” Creates EC2, EIP, and Security Group
  # ============================================================
  terraform:
    name: "ğŸ§± Provision AWS Infrastructure"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Initialize Terraform
        run: terraform init
        working-directory: .  # main.tf is in root

      - name: Apply Terraform
        run: terraform apply -auto-approve
        working-directory: .
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      - name: Capture EC2 Public IP
        id: ec2
        run: |
          echo "EC2_PUBLIC_IP=$(terraform output -raw public_ip)" >> $GITHUB_ENV
        working-directory: .

  # ============================================================
  # ğŸ”¨ BUILD JOB â€” Builds Docker Image for Static Website
  # ============================================================
  build:
    name: "ğŸ”¨ Build Docker Image"
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          echo "ğŸ› ï¸ Building Docker image..."
          docker build --no-cache -t aj-static-site:latest -f docker/Dockerfile ./docker
          echo "âœ… Docker image built successfully!"

      - name: Save Docker Image as tar
        run: |
          echo "ğŸ“¦ Saving Docker image..."
          docker save aj-static-site:latest -o static-web.tar
          chmod 777 static-web.tar
          ls -lh static-web.tar
          echo "âœ… Docker image saved successfully!"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-web
          path: static-web.tar

  # ============================================================
  # ğŸš€ DEPLOY JOB â€” Uploads Image & Deploys via Ansible
  # ============================================================
  deploy:
    name: "ğŸš€ Deploy to EC2 using Ansible"
    runs-on: ubuntu-latest
    needs: [terraform, build]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: static-web
          path: .

      - name: Print EC2 IP
        run: echo "EC2 Public IP: $EC2_PUBLIC_IP"

      # âœ… Step 1: Copy Docker tar file to EC2
      - name: Copy Docker Image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "static-web.tar"
          target: "/home/ubuntu/"
          overwrite: true

      # âœ… Step 2: Deploy with Ansible
      - name: Run Ansible Playbook on EC2
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/deploy.yml
          inventory: |
            [all]
            ${{ env.EC2_PUBLIC_IP }} ansible_user=ubuntu
          key: ${{ secrets.EC2_KEY }}

      # âœ… Step 3: Print Deployment Summary
      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Your static website is live at: http://${{ env.EC2_PUBLIC_IP }}"
