---
# ============================================================
# ğŸ§© Ansible Playbook â€” Deploy Dockerized Static Website on AWS EC2
# ============================================================
# This playbook is triggered from GitHub Actions.
# It assumes Terraform has provisioned an EC2 instance with Docker pre-installed.
# The workflow:
#   1ï¸âƒ£ Ensure Docker is available
#   2ï¸âƒ£ Stop and remove any old container
#   3ï¸âƒ£ Load the new Docker image (copied via SCP)
#   4ï¸âƒ£ Run the updated container on port 80
#   5ï¸âƒ£ Clean up unused resources
#   6ï¸âƒ£ Verify both container and HTTP response
# ============================================================

- name: Deploy Dockerized static website on EC2
  hosts: all
  become: yes

  tasks:
    # ------------------------------------------------------------
    # ğŸ§° Step 1: Ensure Docker is installed and running
    # ------------------------------------------------------------
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: yes

    - name: Install Docker if not present
      apt:
        name: docker.io
        state: present
        update_cache: yes
      when: docker_check.rc != 0

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    # ------------------------------------------------------------
    # ğŸ›‘ Step 2: Stop and remove existing container
    # ------------------------------------------------------------
    - name: Stop old container if running
      shell: docker stop aj-static-site || true

    - name: Remove old container if exists
      shell: docker rm aj-static-site || true

    # ------------------------------------------------------------
    # ğŸ“¦ Step 3: Load the latest Docker image from GitHub artifact
    # ------------------------------------------------------------
    - name: Load new Docker image
      shell: docker load -i /home/ubuntu/static-web.tar

    # ------------------------------------------------------------
    # ğŸš€ Step 4: Run the new Docker container
    # ------------------------------------------------------------
    - name: Run new container from loaded image
      shell: docker run -d -p 80:80 --name aj-static-site aj-static-site:latest

    # ------------------------------------------------------------
    # ğŸ§¹ Step 5: Clean up unused Docker resources
    # ------------------------------------------------------------
    - name: Clean up dangling Docker resources
      shell: docker system prune -f

    # ------------------------------------------------------------
    # âœ… Step 6: Verify deployment status
    # ------------------------------------------------------------
    - name: Check running containers
      shell: >
        docker ps --filter "name=aj-static-site"
        --format "Container: {{'{{'}}.Names{{'}}'}} | Status: {{'{{'}}.Status{{'}}'}}"
      register: container_status

    - name: Display container status
      debug:
        msg: "{{ container_status.stdout | default('No running container found!') }}"

    # ------------------------------------------------------------
    # ğŸŒ Step 7: Verify web response from container
    # ------------------------------------------------------------
    - name: Test website response (HTTP headers)
      shell: curl -I http://localhost:80 || true
      register: http_response

    - name: Display HTTP response
      debug:
        msg: "{{ http_response.stdout_lines }}"
