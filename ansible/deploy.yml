---
# ============================================================
# ğŸ§© Ansible Playbook â€” Deploy Dockerized Static Website on EC2
# ============================================================
# This playbook:
#   1. Stops any old running container
#   2. Removes it (if exists)
#   3. Loads the new Docker image (.tar) copied from GitHub Actions
#   4. Runs the new container on port 80
#   5. Cleans up unused Docker resources
#   6. Verifies that the container and site are running correctly
# ============================================================

- name: Deploy static website container
  hosts: all
  become: yes

  tasks:
    # ------------------------------------------------------------
    # ğŸ›‘ Step 1: Stop old container (if it's running)
    # ------------------------------------------------------------
    - name: Stop old container if running
      shell: docker stop aj-static-site || true
      # Using 'shell' allows the '|| true' syntax â€” avoids failure if container doesn't exist

    # ------------------------------------------------------------
    # ğŸ—‘ï¸ Step 2: Remove any old container (if exists)
    # ------------------------------------------------------------
    - name: Remove old container if exists
      shell: docker rm aj-static-site || true
      # Ensures clean state before deploying a new container

    # ------------------------------------------------------------
    # ğŸ“¦ Step 3: Load the new Docker image from the transferred tar file
    # ------------------------------------------------------------
    - name: Load new image from tar
      shell: docker load -i /home/ubuntu/static-web.tar
      # Imports the saved image into Docker on EC2

    # ------------------------------------------------------------
    # ğŸš€ Step 4: Run the new Docker container
    # ------------------------------------------------------------
    - name: Run new container
      shell: docker run -d -p 80:80 --name aj-static-site aj-static-site:latest
      # -d = detached mode
      # -p 80:80 = map container port 80 to EC2 port 80 (public access)
      # --name = container name
      # aj-static-site:latest = image name built in CI

    # ------------------------------------------------------------
    # ğŸ§¹ Step 5: Clean up unused Docker images/containers
    # ------------------------------------------------------------
    - name: Clean up unused Docker resources
      shell: docker system prune -f
      # Removes dangling images, stopped containers, and unused layers

    # ------------------------------------------------------------
    # âœ… Step 6: Verify deployment (container + web response)
    # ------------------------------------------------------------
    - name: Check running containers
      shell: "docker ps --filter 'name=aj-static-site' --format 'Container: {{.Names}} | Status: {{.Status}}'"
      register: container_status

    - name: Print container status
      debug:
        msg: "{{ container_status.stdout }}"
      # Displays the containerâ€™s name and running status

    - name: Verify that website responds on port 80
      shell: curl -I http://localhost:80 || true
      register: http_response

    - name: Print HTTP response headers
      debug:
        msg: "{{ http_response.stdout_lines }}"
      # Confirms the web server returns HTTP 200 OK or similar
